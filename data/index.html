<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zebrafish Complement System Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f9; margin: 0; }
    header { background: #004d40; color: #fff; padding: 1rem; text-align: center; }
    .container { max-width: 1200px; margin: auto; padding: 1.5rem; }
    section { background: #fff; margin: 1.5rem 0; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .plot-container { width: 100%; height: 600px; position: relative; }
    .loader { border: 8px solid #f3f3f3; border-top: 8px solid #004d40; border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; margin: 100px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    footer { text-align: center; padding: 1rem; font-size: 0.9rem; color: #555; }
  </style>
</head>
<body>

<header>
  <h1>Zebrafish Complement System Dashboard</h1>
</header>

<div class="container">
  <section>
    <h2>📊 Interactive Volcano Plot</h2>
    <p>Hover on points for gene details; zoom and pan freely.</p>
    <div id="volcanoPlot" class="plot-container">
      <div class="loader"></div>
    </div>
  </section>
</div>

<footer>
  <p>Code & data available on <a href="https://github.com/tshrayansh/Zebrafish-complement-dashboard" target="_blank">GitHub</a>.</p>
</footer>

<script>
  // 🔁 DATA LOADING FIX
  // Use a **relative path** to finalize CSV in the same folder
  const dataUrl = 'filtered_expression.csv';

  function createVolcanoPlot(data) {
    const up = { x: [], y: [], text: [], mode: 'markers', name: 'Up-regulated', marker: { color:'red', size:8 } };
    const down = { x: [], y: [], text: [], mode: 'markers', name: 'Down-regulated', marker: { color:'blue', size:8 } };
    const non = { x: [], y: [], text: [], mode: 'markers', name: 'Not Significant', marker: { color:'grey', size:6 } };

    const pThresh = 0.05, fcThresh = 1;
    data.forEach(d => {
      const x = +d.log2FoldChange;
      const y = -Math.log10(+d.pvalue || 1e-100);
      const hover = `Gene: ${d.gene_name}<br>log2FC: ${x.toFixed(2)}<br>p‑value: ${parseFloat(d.pvalue).toExponential(2)}`;
      if (d.pvalue < pThresh && x > fcThresh) { up.x.push(x); up.y.push(y); up.text.push(hover); }
      else if (d.pvalue < pThresh && x < -fcThresh) { down.x.push(x); down.y.push(y); down.text.push(hover); }
      else { non.x.push(x); non.y.push(y); non.text.push(hover); }
    });

    Plotly.newPlot('volcanoPlot', [non, down, up], {
      title: '<b>Volcano Plot</b>',
      xaxis: { title: 'log₂ Fold Change' },
      yaxis: { title: '-log₁₀ p-value' },
      hovermode: 'closest'
    });
  }

  // Load local CSV via D3
  Plotly.d3.csv(dataUrl, (err, rows) => {
    const container = document.getElementById('volcanoPlot');
    if (err) {
      console.error('Error loading data:', err);
      container.innerHTML = '<p style="color:red; text-align:center;">Failed to load data — check the console.</p>';
      return;
    }
    container.querySelector('.loader').style.display = 'none';
    rows.forEach(d => { d.log2FoldChange = +d.log2FoldChange; d.pvalue = +d.pvalue; });
    createVolcanoPlot(rows);
  });
</script>

</body>
</html>
